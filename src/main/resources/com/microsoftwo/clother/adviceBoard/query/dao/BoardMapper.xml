<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.microsoftwo.clother.adviceBoard.query.dao.BoardMapper">
    <!-- BoardDTO에 맞는 결과 매핑 -->
    <resultMap id="BoardResultMap" type="com.microsoftwo.clother.adviceBoard.query.dto.BoardDTO">
        <id column="board_id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="created_at" property="createdAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="image_url" property="imageUrl"/>
    </resultMap>



    <!-- 게시글 목록 조회 -->
    <select id="getBoards" resultMap="BoardResultMap">
        SELECT
        a.id AS board_id,
        a.user_id,
        a.title,
        a.content,
        a.created_at,
        a.is_deleted,
        -- 대표 이미지 (첫 번째 이미지)
        (SELECT i2.image_url
        FROM advice_board_image i2
        WHERE i2.board_id = a.id
        ORDER BY i2.order ASC
        LIMIT 1) AS image_url
        FROM
        advice_board a
        WHERE
        a.is_deleted = FALSE
        ORDER BY
        <choose>
            <when test="sortBy == 'likes'"> a.likes DESC </when>
            <otherwise> a.created_at DESC </otherwise>
        </choose>
    </select>




    <!--           SELECT * FROM board ORDER BY id DESC LIMIT #{limit} OFFSET #{offset}-->
    <!-- 게시글 상세 조회 -->
    <select id="getBoardById" resultType="com.microsoftwo.clother.adviceBoard.query.dto.BoardDTO">
        SELECT * FROM board WHERE id = #{id}
    </select>

    <!-- 게시글의 사진 조회 -->
    <select id="getBoardImages" resultType="String">
        SELECT image_url FROM board_image WHERE board_id = #{boardId}
    </select>

</mapper>
